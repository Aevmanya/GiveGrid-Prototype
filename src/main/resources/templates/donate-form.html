<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Donation Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Donation Details</h2>
    <hr>

    <form action="/donate/submit" method="post" id="donationForm">
        <input type="hidden" name="itemId" th:value="${item.id}" />

        <!-- Top card -->
        <div class="card p-3 mb-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 th:text="${item.product.name}">Product</h5>
                    <p>
                        <strong>Quantity required:</strong>
                        <span th:text="${item.product.quantity}">0</span>

                        &nbsp;|&nbsp;
                        <small>In cart:
                            <span th:text="${item.quantity}">0</span>
                        </small>
                    </p>
                </div>

                <div class="col-md-6">
                    <label>How many units do you want to donate?</label>

                    <!-- ✔ FIXED: correct max based on cart quantity -->
                    <input id="donateCount"
                           type="number"
                           name="donateCount"
                           class="form-control"
                           min="1"
                           th:attr="max=${item.quantity}"
                           value="1"/>


                    <!-- ✔ FIXED: display correct max -->
                    <small class="text-muted">
                        Max: <span th:text="${item.quantity}">0</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Dynamic per-unit boxes -->
        <div id="unitBoxes"></div>

        <button type="submit" class="btn btn-success mt-3">Submit Donation</button>
    </form>
</div>

<script>
    const donateCountInput = document.getElementById('donateCount');
    const unitBoxes = document.getElementById('unitBoxes');

    // ✔ correct max read
    let maxAllowed = parseInt(donateCountInput.max);

    function renderBoxes() {
        unitBoxes.innerHTML = '';
        let count = parseInt(donateCountInput.value || '1');

        if (count < 1) count = 1;
        if (count > maxAllowed) count = maxAllowed;

        donateCountInput.value = count;

        for (let i = 0; i < count; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'card p-3 mb-2';
            wrapper.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <strong>${document.querySelector('h5').innerText}</strong>
                        <p>Unit #${i + 1}</p>
                    </div>
                    <div class="col-md-4">
                        <label>Condition</label>

                        <!-- ✔ FIXED: Spring array binding -->
                        <select name="condition[]" class="form-control" required>
                            <option value="New" selected>New</option>
                            <option value="Used">Used</option>
                            <option value="Slightly Used">Slightly Used</option>
                        </select>
                    </div>
                </div>
            `;
            unitBoxes.appendChild(wrapper);
        }
    }

    donateCountInput.addEventListener('input', () => renderBoxes());

    renderBoxes();
</script>
</body>
</html>
